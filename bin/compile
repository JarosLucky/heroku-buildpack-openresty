#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# Fail fast and fail hard.
set -eo pipefail

OPENRESTY_VERSION=1.7.7.2
LUAROCKS_VERSION=2.2.0
# It's too hard to handle all the variants of the LuaJIT version...

BUILD_DIR=$1
CACHE_DIR=$2

mkdir -p $BUILD_DIR/bin
mkdir -p $BUILD_DIR/lib
mkdir -p $BUILD_DIR/include

if [ ! -d "$CACHE_DIR" ]; then
  mkdir -p $CACHE_DIR
fi

if [ ! -d "$CACHE_DIR/ngx_openresty-$OPENRESTY_VERSION" ]; then
  cd $CACHE_DIR
  echo "-----> Building openresty"
  wget -O - http://openresty.org/download/ngx_openresty-$OPENRESTY_VERSION.tar.gz | tar xz
  cd ngx_openresty-$OPENRESTY_VERSION
  PATH=$PATH:/sbin ./configure --prefix=$BUILD_DIR/openresty --with-pcre-jit --with-ipv6
  make
  cd ..
fi
echo "-----> Installing openresty"
cd $CACHE_DIR/ngx_openresty-$OPENRESTY_VERSION
make install

exit 0

ln -s $BUILD_DIR/openresty/luajit/bin/luajit-2.1.0-alpha $BUILD_DIR/bin/lua
ln -s $BULD_DIR/openresty/luajit/lib/libluajit-5.1.so.2.1.0 $BUILD_DIR/lib/lubluajit-5.1.so.2
ln -s $BUILD_DIR/openresty/luajit/include/luajit-2.1 $BUILD_DIR/include/luajit-2.1
ln -s $BUILD_DIR/openresty/nginx/sbin/nginx $BUILD_DIR/bin/nginx
#ln -s $CACHE_DIR/openresty/lualib $BUILD_DIR/lib/lualib

if [ ! -d "$CACHE_DIR/luarocks-$LUAROCKS_VERSION" ]; then
  echo "-----> Building LuaRocks"
  cd $CACHE_DIR
  wget -O - http://luarocks.org/releases/luarocks-$LUAROCKS_VERSION.tar.gz | tar xz
  cd luarocks-$LUAROCKS_VERSION
  ./configure \
    --prefix=$BUILD_DIR \
    --with-lua=$BUILD_DIR \
    --with-lua-include=$BUILD_DIR/include/luajit-2.1 \
    --rocks-tree=$BUILD_DIR/lib/luarocks
  make
  cd ..
fi
echo "-----> Installing LuaRocks"
cd $CACHE_DIR/luarocks-$LUAROCKS_VERSION
make install


cd $BUILD_DIR

# use sed because grep halts script with -e when there is no match
ROCKSPEC=$(ls | sed -n 's/\.rockspec$/&/p' | head -n 1)

echo "-----> Installing dependencies"
echo $ROCKSPEC
#$BUILD_DIR/bin/luarocks make $ROCKSPEC
