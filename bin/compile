#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# Fail fast and fail hard.
set -eo pipefail

OPENRESTY_VERSION=1.7.7.2
LUAROCKS_VERSION=2.2.0
# It's too hard to handle all the variants of the LuaJIT version...

BUILD_DIR=$1
CACHE_DIR=$2

TOOLS_DIR=$BUILD_DIR/tools
mkdir -p $TOOLS_DIR/bin
mkdir -p $TOOLS_DIR/lib
mkdir -p $TOOLS_DIR/include
ln -s $TOOLS_DIR /app/tools

if [ ! -d "$CACHE_DIR" ]; then
  mkdir -p $CACHE_DIR
fi

if [ ! -d "$CACHE_DIR/ngx_openresty-$OPENRESTY_VERSION" ]; then
  cd $CACHE_DIR
  echo "-----> Building openresty"
  wget -O - http://openresty.org/download/ngx_openresty-$OPENRESTY_VERSION.tar.gz | tar xz
  cd ngx_openresty-$OPENRESTY_VERSION
  PATH=$PATH:/sbin ./configure --prefix=/app/tools/openresty --with-pcre-jit --with-ipv6
  make
  cd ..
fi
echo "-----> Installing openresty"
cd $CACHE_DIR/ngx_openresty-$OPENRESTY_VERSION
make install

ln -s $TOOLS_DIR/openresty/luajit/bin/luajit-2.1.0-alpha $TOOLS_DIR/bin/lua
ln -s $TOOLS_DIR/openresty/luajit/lib/libluajit-5.1.so.2.1.0 $TOOLS_DIR/lib/lubluajit-5.1.so.2
ln -s $TOOLS_DIR/openresty/luajit/include/luajit-2.1 $TOOLS_DIR/include/luajit-2.1
ln -s $TOOLS_DIR/openresty/nginx/sbin/nginx $TOOLS_DIR/bin/nginx
#ln -s $CACHE_DIR/openresty/lualib $BUILD_DIR/lib/lualib

$TOOLS_DIR/bin/lua -e "print(package.path)"

if [ ! -d "$CACHE_DIR/luarocks-$LUAROCKS_VERSION" ]; then
  echo "-----> Building LuaRocks"
  set -x
  cd $CACHE_DIR
  wget -O - http://luarocks.org/releases/luarocks-$LUAROCKS_VERSION.tar.gz | tar xz
  cd luarocks-$LUAROCKS_VERSION
  ./configure \
    --prefix=$TOOLS_DIR \
    --with-lua=$BUILD_DIR \
    --with-lua-include=$TOOLS_DIR/include/luajit-2.1 \
    --rocks-tree=$TOOLS_DIR/lib/luarocks
  make
  cd ..
fi
echo "-----> Installing LuaRocks"
cd $CACHE_DIR/luarocks-$LUAROCKS_VERSION
make install


cd $BUILD_DIR

# use sed because grep halts script with -e when there is no match
ROCKSPEC=$(ls | sed -n 's/\.rockspec$/&/p' | head -n 1)

echo "-----> Installing dependencies"
echo $ROCKSPEC
$TOOLS_DIR/bin/luarocks make $ROCKSPEC
