#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# Fail fast and fail hard.
set -eo pipefail

OPENRESTY_VERSION=1.7.7.2
LUAROCKS_VERSION=2.2.0
# It's too hard to handle all the variants of the LuaJIT version...

BIN_DIR=$(cd $(dirname $0); pwd)
ROOT_DIR=$(dirname $BIN_DIR)
BUILD_DIR=$1
CACHE_DIR=$2

echo "-----> Creating profile.d"
cp -r $ROOT_DIR/.profile.d $BUILD_DIR

TOOLS_DIR=$BUILD_DIR/tools
mkdir -p $TOOLS_DIR/bin
mkdir -p $TOOLS_DIR/lib
mkdir -p $TOOLS_DIR/include
ln -s $TOOLS_DIR /app/tools

if [ ! -d "$CACHE_DIR" ]; then
  mkdir -p $CACHE_DIR
fi

# Install OpenResty

if [ ! -d "$CACHE_DIR/ngx_openresty-$OPENRESTY_VERSION" ]; then
  cd $CACHE_DIR
  echo "-----> Building openresty $OPENRESTY_VERSION"
  wget -O - http://openresty.org/download/ngx_openresty-$OPENRESTY_VERSION.tar.gz | tar xz
  cd ngx_openresty-$OPENRESTY_VERSION
  PATH=$PATH:/sbin ./configure --prefix=/app/tools/openresty --with-pcre-jit --with-ipv6
  make
  cd ..
fi
echo "-----> Installing openresty $OPENRESTY_VERSION"
cd $CACHE_DIR/ngx_openresty-$OPENRESTY_VERSION
make install
mkdir -p $BUILD_DIR/logs

ln -s /app/tools/openresty/luajit/bin/luajit-2.1.0-alpha /app/tools/bin/lua
ln -s /app/tools/openresty/luajit/lib/libluajit-5.1.so.2.1.0 /app/tools/lib/libluajit-5.1.so.2
ln -s /app/tools/openresty/luajit/include/luajit-2.1 /app/tools/include/luajit-2.1
ln -s /app/tools/openresty/nginx/sbin/nginx /app/tools/bin/nginx


# Install LuaRocks

if [ ! -d "$CACHE_DIR/luarocks-$LUAROCKS_VERSION" ]; then
  echo "-----> Building LuaRocks $LUAROCKS_VERSION"
  cd $CACHE_DIR
  wget -O - http://luarocks.org/releases/luarocks-$LUAROCKS_VERSION.tar.gz | tar xz
  cd luarocks-$LUAROCKS_VERSION
  ./configure \
    --prefix=/app/tools \
    --with-lua=/app/tools \
    --with-lua-include=/app/tools/include/luajit-2.1 \
    --rocks-tree=/app/tools/lib/luarocks
  make
  cd ..
fi
echo "-----> Installing LuaRocks $LUAROCKS_VERSION"
cd $CACHE_DIR/luarocks-$LUAROCKS_VERSION
make install


cd $BUILD_DIR

# use sed because grep halts script with -e when there is no match
ROCKSPEC=$(ls | sed -n 's/\.rockspec$/&/p' | head -n 1)

echo "-----> Installing dependencies"
echo $ROCKSPEC
PATH=/app/tools/bin:$PATH \
LD_LIBRARY_PATH=/app/tools/lib \
LUA_PATH=/app/tools/share/lua/5.1/?.lua \
LUA_CPATH=/app/tools/lib/lua/5.1/?.so \
/app/tools/bin/luarocks make $ROCKSPEC
